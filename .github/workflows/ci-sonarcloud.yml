name: CI SonarCloud

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  build-test-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
      SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10'

      - name: Frontend install + build
        working-directory: frontend
        run: |
          pnpm install --frozen-lockfile
          pnpm build

      - name: Backend Gradle Test + Coverage Report
        working-directory: backend
        run: |
          chmod +x gradlew
          ./gradlew test jacocoTestReport --no-daemon

      - name: Validate SonarCloud Configuration
        run: |
          if [ -z "$SONAR_PROJECT_KEY" ]; then
            echo "::error::Missing GitHub secret SONAR_PROJECT_KEY"
            exit 1
          fi
          if [ -z "$SONAR_ORGANIZATION" ]; then
            echo "::error::Missing GitHub secret SONAR_ORGANIZATION"
            exit 1
          fi
          if [ -z "$SONAR_TOKEN" ]; then
            echo "::error::Missing GitHub secret SONAR_TOKEN"
            exit 1
          fi

      - name: SonarCloud Scan
        uses: sonarsource/sonarqube-scan-action@v6
        env:
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectKey=${{ env.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ env.SONAR_ORGANIZATION }}
            -Dsonar.projectName=palmery-auth
            -Dsonar.sourceEncoding=UTF-8
            -Dsonar.sources=backend/src/main,frontend/app,frontend/lib
            -Dsonar.tests=backend/src/test
            -Dsonar.java.binaries=backend/build/classes/java/main
            -Dsonar.coverage.jacoco.xmlReportPaths=backend/build/reports/jacoco/test/jacocoTestReport.xml
            -Dsonar.exclusions=**/.next/**,**/node_modules/**,**/build/**

      - name: SonarCloud Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          pollingTimeoutSec: 300
